using System.Collections.Concurrent;
using System.Net;
using System.Net.Sockets;
using Server.Features.Networking.Services;

namespace Server.Features.Server;

public class Server(INetworkingService networkingService)
{
    private int _clientId;
    private const int Port = 50000; // TODO: read port from config
    private readonly ConcurrentDictionary<int, TcpClient> _clients = new();
    private readonly TcpListener _server = new(IPAddress.Any, Port);

    public async Task RunServer(CancellationToken cancellationToken)
    {
        _server.Start();
        Console.WriteLine($"[i] Started server on port {Port}");
        
        while (!cancellationToken.IsCancellationRequested)
        {
            if (!_server.Pending())
            {
                await Task.Delay(1000, cancellationToken);
                continue;
            }
            
            var client = await _server.AcceptTcpClientAsync(cancellationToken);
            var currentId = _clientId++;
            _clients.TryAdd(currentId, client);
            Console.WriteLine($"[i] New connection from {client.Client.RemoteEndPoint}");

            await Task.Run(() => networkingService.HandleNewConnection(client, currentId, _clients), cancellationToken);
        }
    }
}