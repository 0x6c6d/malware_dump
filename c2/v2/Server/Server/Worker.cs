using System.Collections.Concurrent;
using System.Net;
using System.Net.Sockets;
using Server.Features.Tcp.Services;

namespace Server;

public class Worker(IConnectionHandler connectionHandler) : BackgroundService
{
    private int _clientId;
    // TODO: read port from config
    private const int Port = 50000;
    

    private readonly ConcurrentDictionary<int, TcpClient> _clients = new();
    private readonly TcpListener _server = new(IPAddress.Any, Port);

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _server.Start();
        Console.WriteLine($"[i] Started server on port {Port}");
        
        while (!stoppingToken.IsCancellationRequested)
        {
            if (!_server.Pending())
            {
                await Task.Delay(1000, stoppingToken);
                continue;
            }

            var client = await _server.AcceptTcpClientAsync(stoppingToken);
            var currentId = _clientId++;
            _clients.TryAdd(currentId, client);
            Console.WriteLine($"[i] New connection from {client.Client.RemoteEndPoint}");

            await Task.Run(() => connectionHandler.HandleNewClient(client, currentId, _clients), stoppingToken);
        }
    }
}