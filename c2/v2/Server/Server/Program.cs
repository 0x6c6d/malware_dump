using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Server.Common;

// register services
using var host = Host.CreateDefaultBuilder(args)
    .ConfigureServices((context, services) =>
    {
        services.ConfigureServices();
    })
    .Build();

var server = host.Services.GetRequiredService<Server.Features.Server.Server>();
var cts = new CancellationTokenSource();

// run the server
var serverTask = Task.Run(() => server.RunServer(cts.Token), cts.Token);

// handle shutdown on Ctrl+C
Console.CancelKeyPress += (sender, eventArgs) =>
{
    eventArgs.Cancel = true;
    cts.Cancel();
};

await serverTask;
await host.RunAsync();