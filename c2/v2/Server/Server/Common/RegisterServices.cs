using Microsoft.EntityFrameworkCore;
using Persistence.Common.Persistence;
using Persistence.Features.Client.Repositories;
using Persistence.Features.Client.Services;
using Server.Features.Networking.Services;

namespace Server.Common;

public static class RegisterServices
{
    public static void ConfigureServices(this HostApplicationBuilder builder)
    {
        // default stuff
        builder.Services.AddHostedService<Worker>();
        
        // services - Server
        builder.Services.AddScoped<INetworkingService, NetworkingService>();
        
        // services - Persistence
        builder.Services.AddScoped<IClientRepository, ClientRepository>();
        builder.Services.AddScoped<IClientService, ClientService>();
        
        // database
        // TODO: get connection string from config
        builder.Services.AddDbContext<DataContext>(options =>
            options.UseSqlite("Data Source=/home/lucas/workspace/code/db/c2.sqlite"));
        
        // MediatR: ensures that MediatR searches for handlers within the class library "Persistence"
        const string classLibraryName = "Persistence";
        var assembly = AppDomain.CurrentDomain.GetAssemblies().FirstOrDefault(a => a.GetName().Name == classLibraryName);
        builder.Services.AddMediatR(configuration =>
        {
            if (assembly != null) configuration.RegisterServicesFromAssembly(assembly);
        });
    }
}