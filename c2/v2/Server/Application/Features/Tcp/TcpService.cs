using System.Net;
using System.Net.Sockets;
using System.Text;

namespace Application.Features.Tcp;

public class TcpService
{
    private static readonly int Port = 50000;
    private readonly TcpListener _listener = new(IPAddress.Any, Port);

    public void StartTcpServer()
    {
        _listener.Start();
        Console.WriteLine($"Server started on port {Port}. Waiting for clients...");

        while (true)
        {
            TcpClient client = _listener.AcceptTcpClient();
            IPEndPoint? remoteEndPoint = client.Client.RemoteEndPoint as IPEndPoint;
            if (remoteEndPoint != null)
            {
                Console.WriteLine($"New Client: {remoteEndPoint.Address.ToString()} {remoteEndPoint.Port.ToString()}");
            }
            
            NetworkStream networkStream = client.GetStream();
            byte[] msgSend = new byte[100];
            msgSend = Encoding.Default.GetBytes("whoami");

            networkStream.Write(msgSend, 0, msgSend.Length);

            while (client.Connected)
            {
                byte[] msgReceive = new byte[1024];
                networkStream.Read(msgReceive, 0, msgReceive.Length);
                Console.WriteLine(Encoding.Default.GetString(msgReceive));
            }

            client.Close();
        }
    }
}